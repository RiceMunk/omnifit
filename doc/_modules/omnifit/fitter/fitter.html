<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>omnifit.fitter.fitter &mdash; omnifit v0.1</title>
    
    <link rel="stylesheet" href="../../../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/astropy_logo.ico"/>
    <link rel="top" title="omnifit v0.1" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>
<script type="text/javascript" src="../../../_static/copybutton.js"></script>


  </head>
  <body role="document">
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../index.html"><span id="logotext1">astro</span><span id="logotext2">py</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
    <li><a title="General Index" href="../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../index.html">omnifit v0.1</a>
	 &raquo;
      </li>
      <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for omnifit.fitter.fitter</h1><div class="highlight"><pre>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">lmfit</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">Parameters</span><span class="p">,</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">spectrum</span>
<span class="kn">from</span> <span class="nn">functions</span> <span class="kn">import</span> <span class="o">*</span>

<div class="viewcode-block" id="Fitter"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter">[docs]</a><span class="k">class</span> <span class="nc">Fitter</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A class for multi-component fitting to spectroscopic data of ices.</span>

<span class="sd">  This is the heart of Omnifit, which receives spectra from the spectrum</span>
<span class="sd">  module, and is then capable of fitting an arbitrary number of different</span>
<span class="sd">  components to the target spectrum thus designated.</span>

<span class="sd">  Attributes</span>
<span class="sd">  ----------</span>
<span class="sd">  target_x : `numpy.ndarray`</span>
<span class="sd">    The x axis of the target spectrum, e.g. the wavelength.</span>
<span class="sd">  target_y : `numpy.ndarray`</span>
<span class="sd">    The y axis of the target spectrum, e.g. the optical depth.</span>
<span class="sd">  target_dy : `float`</span>
<span class="sd">    A single number expressing the average uncertainty of the y</span>
<span class="sd">    axis data.</span>
<span class="sd">  modelname : `string`</span>
<span class="sd">    A human-readable name for the model being fitted.</span>
<span class="sd">  psf : `Nonetype`, `numpy.ndarray`, or `astropy.convolution.Kernel`</span>
<span class="sd">    If set, this attribute can be used to give a kernel which should</span>
<span class="sd">    be used to convolve all the fitted data with.</span>
<span class="sd">  fitrange : `Nonetype` or `list`</span>
<span class="sd">    If set, this specifies the inclusive limits to which</span>
<span class="sd">    the fitting should be performed in x axis coordinates.</span>
<span class="sd">    For example a fitrange of [[200,250],[300,350]] sets</span>
<span class="sd">    two fitting windows of 200 to 250, and 300 to 350.</span>
<span class="sd">  color : `string`</span>
<span class="sd">    A string inidcating the desired plotting color of the target</span>
<span class="sd">    data, in a format understandable by matplotlib.</span>
<span class="sd">  funclist : `list`</span>
<span class="sd">    A list containing all the fittable functions. Each list entry</span>
<span class="sd">    is a dictionary containing the following keys and values:</span>

<span class="sd">      * &#39;name&#39; : A human-readable name for the function being fitted,</span>
<span class="sd">        in string format.</span>
<span class="sd">      * &#39;color&#39; : A string inidcating the desired plotting color of</span>
<span class="sd">        the data, in a format understandable by matplotlib.</span>
<span class="sd">      * &#39;type&#39; : A string indicating what type of data the function</span>
<span class="sd">        consists of. It can be either &#39;analytical&#39; or &#39;empirical&#39;,</span>
<span class="sd">        indicating an analytical function or empirical spectrum,</span>
<span class="sd">        respectively.</span>
<span class="sd">      * &#39;shape&#39; : The shape of the function being fitted. In the case</span>
<span class="sd">        of an analytical function, this is a string indicating the</span>
<span class="sd">        callable name of the function. In the case of an empirical</span>
<span class="sd">        spectrum, this is the y-axis data from the spectrum.</span>
<span class="sd">      * &#39;params&#39; : an lmfit `Parameters` instance containing the fitting</span>
<span class="sd">        parameters appropriate to the data being fitted.</span>

<span class="sd">  fitpars : `Parameters`</span>
<span class="sd">    This is where the fitting parameters are stored during and after</span>
<span class="sd">    minimization.</span>
<span class="sd">  fitres : `Minimizer`</span>
<span class="sd">    The fitting results are stored in this class, as documented in</span>
<span class="sd">    lmfit.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">dy</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">modelname</span><span class="o">=</span><span class="s">&#39;Unknown model&#39;</span><span class="p">,</span><span class="n">psf</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">fitrange</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;black&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitter(x,y,dy=1.0,modelname=&#39;Unknown model&#39;,psf=None,fitrange=None,color=&#39;black&#39;)</span>

<span class="sd">    Constructor for the Fitter class. Initialisation happens by</span>
<span class="sd">    designating the target spectrum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : `numpy.ndarray`</span>
<span class="sd">      The x axis of the target spectrum, e.g. the wavelength.</span>
<span class="sd">    y : `numpy.ndarray`</span>
<span class="sd">      The y axis of the target spectrum, e.g. the optical depth.</span>
<span class="sd">    dy : `float`, optional</span>
<span class="sd">      A single number expressing the average uncertainty of the y</span>
<span class="sd">      axis data.</span>
<span class="sd">    modelname : `string`, optional</span>
<span class="sd">      A human-readable name for the model being fitted.</span>
<span class="sd">    psf : Nonetype or numpy.ndarray or astropy.convolution.Kernel, optional</span>
<span class="sd">      This attribute can be used to give a kernel which should be</span>
<span class="sd">      used to convolve all the fitted data with.</span>
<span class="sd">    fitrange : `Nonetype` or `list`, optional</span>
<span class="sd">      If set, this specifies the inclusive limits to which</span>
<span class="sd">      the fitting should be performed in x axis coordinates.</span>
<span class="sd">      For example a fitrange of [[200,250],[300,350]] sets</span>
<span class="sd">      two fitting windows of 200 to 250, and 300 to 350.</span>
<span class="sd">    color : `string`, optional</span>
<span class="sd">      A string inidcating the desired plotting color of the target</span>
<span class="sd">      data, in a format understandable by matplotlib.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Input arrays have different sizes.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="o">=</span><span class="n">x</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="o">=</span><span class="n">y</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">target_dy</span><span class="o">=</span><span class="n">dy</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modelname</span><span class="o">=</span><span class="n">modelname</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="o">=</span><span class="n">psf</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span><span class="o">=</span><span class="n">fitrange</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="o">=</span><span class="n">color</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="o">=</span><span class="p">[]</span>
  <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Fitter.fromspectrum"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.fromspectrum">[docs]</a>  <span class="k">def</span> <span class="nf">fromspectrum</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fitter.fromspectrum(spectrum,**kwargs)</span>

<span class="sd">    An alternate way to initialise Fitter, by directly giving it</span>
<span class="sd">    a spectrum. Extracted data from the spectrum are the x, y,</span>
<span class="sd">    and (if the spectrum has been baselined) dy parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum : `omnifit.spectrum.BaseSpectrum` or its child class</span>
<span class="sd">      The input spectrum.</span>
<span class="sd">    **kwargs : Arguments, optional</span>
<span class="sd">      Additional initialisation arguments can be passed to `Fitter`</span>
<span class="sd">      using this. Note that x and y (and dy, if applicable) are defined</span>
<span class="sd">      using the data contained in the input spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">baselined</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">spectrum</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">spectrum</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">spectrum</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
<div class="viewcode-block" id="Fitter.add_empirical"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.add_empirical">[docs]</a>  <span class="k">def</span> <span class="nf">add_empirical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">spectrum</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">funcname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add_empirical(spectrum,params,funcname=None,color=&#39;red&#39;)</span>

<span class="sd">    Add empirical data in the form of a spectrum to the fitting list.</span>
<span class="sd">    The spectrum must be interpolated to match the target x axis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spectrum : `spectrum.BaseSpectrum`</span>
<span class="sd">      The input spectrum.</span>
<span class="sd">    params : `Parameters`</span>
<span class="sd">      The input parameters. Specifically this must contain</span>
<span class="sd">      the &#39;mul&#39; parameter, which indicates what value the</span>
<span class="sd">      spectrum will be multiplied with during fitting.</span>
<span class="sd">    funcname : `Nonetype` or `string`, optional</span>
<span class="sd">      A human-readable name for the data being fitted.</span>
<span class="sd">      If this is left as None, the name of the spectrum will</span>
<span class="sd">      be used.</span>
<span class="sd">    color : `string`, optional</span>
<span class="sd">      A string inidcating the desired plotting color of the</span>
<span class="sd">      data, in a format understandable by matplotlib.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">funcname</span><span class="p">):</span>
      <span class="n">funcname</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Input spectrum x axis does not match the target spectrum x axis.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;empirical&#39;</span><span class="p">,</span><span class="s">&#39;shape&#39;</span><span class="p">:</span><span class="n">spectrum</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="s">&#39;params&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">funcname</span><span class="p">,</span><span class="s">&#39;color&#39;</span><span class="p">:</span><span class="n">color</span><span class="p">})</span></div>
<div class="viewcode-block" id="Fitter.add_analytical"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.add_analytical">[docs]</a>  <span class="k">def</span> <span class="nf">add_analytical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">funcname</span><span class="o">=</span><span class="s">&#39;Unknown function&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add_analytical(shape,params,funcname=None,color=&#39;red&#39;)</span>

<span class="sd">    Add analytical data in the form of a callable function to the</span>
<span class="sd">    fitting list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shape : `string`</span>
<span class="sd">      The callable name of the function to be fitted.</span>
<span class="sd">    params : `Parameters`</span>
<span class="sd">      The input parameters. These should be formatted in a way that</span>
<span class="sd">      the function defined by shape can understand them, and that</span>
<span class="sd">      function should be created in such a way that it can make use</span>
<span class="sd">      of lmfit parameters.</span>
<span class="sd">    funcname : `string`, optional</span>
<span class="sd">      A human-readable name for the data being fitted.</span>
<span class="sd">    color : `string`, optional</span>
<span class="sd">      A string inidcating the desired plotting color of the</span>
<span class="sd">      data, in a format understandable by matplotlib.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&#39;analytical&#39;</span><span class="p">,</span><span class="s">&#39;shape&#39;</span><span class="p">:</span><span class="n">shape</span><span class="p">,</span><span class="s">&#39;params&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">funcname</span><span class="p">,</span><span class="s">&#39;color&#39;</span><span class="p">:</span><span class="n">color</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="Fitter.perform_fit"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.perform_fit">[docs]</a>  <span class="k">def</span> <span class="nf">perform_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    perform_fit(**kwargs)</span>

<span class="sd">    Uses `minimize` in lmfit to perform least-squares fitting of all the</span>
<span class="sd">    functions in the function list to the target data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    **kwargs : Arguments, optional</span>
<span class="sd">      This can be used to give additional arguments for `minimize`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__extract_pars</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="o">=</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fit_residual</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitres</span><span class="o">.</span><span class="n">success</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Fitting failed!&#39;</span><span class="p">)</span></div>
  <span class="k">def</span> <span class="nf">__fit_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">custrange</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __fit_residual(params,custrange=None)</span>

<span class="sd">    This is an internal function used for calculating the total</span>
<span class="sd">    residual of the data against the fittings function(s), given</span>
<span class="sd">    a set of lmfit parameters. The residual calculation can also</span>
<span class="sd">    be limited to a specific x axis range.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : `Parameters`</span>
<span class="sd">      The parameters used for calculating the residual.</span>
<span class="sd">    custrange : `Nonetype` or `list`, optional</span>
<span class="sd">      If set, this specifies the inclusive range within which</span>
<span class="sd">      the residual is calculated. Otherwise the fitting range</span>
<span class="sd">      specified during Initialisation is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The residual function within the fitting range with the given</span>
<span class="sd">    lmfit parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">custrange</span><span class="o">==</span><span class="bp">None</span><span class="p">:</span>
      <span class="n">fitrange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">fitrange</span><span class="o">=</span><span class="n">custrange</span>
    <span class="n">residual</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">target_y</span>
    <span class="n">totModel</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">residual</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">oPar</span><span class="o">=</span><span class="n">Parameters</span><span class="p">()</span>
      <span class="n">cParlist</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">cPar</span> <span class="ow">in</span> <span class="n">cParlist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">cParams</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">oPar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">value</span><span class="o">=</span><span class="n">cParams</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">cParams</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span>
                 <span class="nb">min</span><span class="o">=</span><span class="n">cParams</span><span class="o">.</span><span class="n">min</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">cParams</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                 <span class="n">expr</span><span class="o">=</span><span class="n">cParams</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
      <span class="n">residual</span><span class="o">-=</span><span class="bp">self</span><span class="o">.</span><span class="n">__parse_function</span><span class="p">(</span><span class="n">oPar</span><span class="p">,</span><span class="n">cFunc</span><span class="p">)</span>
    <span class="c">#Crop out not-numbers and fitting range exterior if necessary</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">fitrange</span><span class="p">):</span>
      <span class="n">fitInd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">cRange</span> <span class="ow">in</span> <span class="n">fitrange</span><span class="p">:</span>
        <span class="n">fitInd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">fitInd</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
               <span class="n">np</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span><span class="n">cRange</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">),</span>
               <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">cRange</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">fitInd</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">residual</span><span class="p">[</span><span class="n">fitInd</span><span class="p">]</span>
<div class="viewcode-block" id="Fitter.chisq"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.chisq">[docs]</a>  <span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">checkrange</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    chisq(checkrange=None)</span>

<span class="sd">    Return chi squared of fit, either in a custom range </span>
<span class="sd">    or in the range used by the fit.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    checkrange : `Nonetype` or `list`, optional</span>
<span class="sd">      If set, this specifies the inclusive range within which</span>
<span class="sd">      the chi squared value is calculated. Otherwise the fitting </span>
<span class="sd">      range specified during Initialisation is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The chi squared within the desired ranged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fit_residual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">,</span><span class="n">custrange</span><span class="o">=</span><span class="n">checkrange</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">residual</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_dy</span><span class="o">**</span><span class="mf">2.0</span><span class="p">))</span></div>
<div class="viewcode-block" id="Fitter.plot_fitresults"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.plot_fitresults">[docs]</a>  <span class="k">def</span> <span class="nf">plot_fitresults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span><span class="n">color_total</span><span class="o">=</span><span class="s">&#39;blue&#39;</span><span class="p">,</span><span class="n">legend</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    plot_fitresults(ax,lw=[1,2,3],color_total=&#39;blue&#39;,legend=True,**kwargs)</span>
<span class="sd">    </span>
<span class="sd">    Plot the fitting results to the given matplotlib axis, with a</span>
<span class="sd">    number of optional parameters specifying how the different plottable</span>
<span class="sd">    components are presented.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    axis : `matplotlib.axis`</span>
<span class="sd">      The axis which the plot will be generated in.</span>
<span class="sd">    lw : `list`, optional</span>
<span class="sd">      This list of 3 numbers specifies the line widths of the target</span>
<span class="sd">      spectrum, the fitted functions, and the total fit, respectively.</span>
<span class="sd">    color_total : `string`, optional</span>
<span class="sd">      A string inidcating the desired plotting color of the total sum</span>
<span class="sd">      of the fit results, in a format understandable by matplotlib.</span>
<span class="sd">      The colors of the target spectrum and the fitted functions are</span>
<span class="sd">      specified during their initialisation and addition.</span>
<span class="sd">    legend : `bool`, optional</span>
<span class="sd">      If set to True, a legend is automatically created using the</span>
<span class="sd">      target spectrum and fitted function names.</span>
<span class="sd">    **kwargs : Arguments, optional</span>
<span class="sd">      This can be used to pass additional arguments</span>
<span class="sd">      to `matplotlib.pyplot.plot`, which is used by this </span>
<span class="sd">      method for its plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">legList</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modelname</span><span class="p">]</span>
    <span class="c">#totres=self.targ_y+self.fitres.residual</span>
    <span class="n">totRes</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">oPar</span><span class="o">=</span><span class="n">Parameters</span><span class="p">()</span>
      <span class="n">cParList</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
      <span class="n">cCol</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">cPar</span> <span class="ow">in</span> <span class="n">cParList</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">cFitPar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">oPar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">value</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span>
                 <span class="nb">min</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">min</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                 <span class="n">expr</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
      <span class="n">funcRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_function</span><span class="p">(</span><span class="n">oPar</span><span class="p">,</span><span class="n">cFunc</span><span class="p">)</span>
      <span class="n">totRes</span><span class="o">+=</span><span class="n">funcRes</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span><span class="n">funcRes</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">cCol</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="n">legList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
    <span class="n">legList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Total fit&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span><span class="n">totRes</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color_total</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legList</span><span class="p">,</span><span class="n">shadow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></div>
<div class="viewcode-block" id="Fitter.fitresults_tofile"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.fitresults_tofile">[docs]</a>  <span class="k">def</span> <span class="nf">fitresults_tofile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">detection_threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fitresults_tofile(filename)</span>

<span class="sd">    Export fit results to two output files which are intended to be</span>
<span class="sd">    easily readable and paraseable with other software.</span>

<span class="sd">    The first file is filename.csv, which contains x and y data of</span>
<span class="sd">    the fitted models, as would be visualized in a plotted fit result.</span>
<span class="sd">    The first column of the csv is the x value, which is shared by all</span>
<span class="sd">    models.</span>
<span class="sd">    The second column is the y value of data that was being fitted to.</span>
<span class="sd">    The third column is total sum of fitted models.</span>
<span class="sd">    The fourth to Nth columns are the individual models, in the order</span>
<span class="sd">    described in the second file, filename.xml.</span>

<span class="sd">    The second file, filename.xml is an XML file containing additional</span>
<span class="sd">    information about the fitted data and the fit results which are not</span>
<span class="sd">    easily representable in a csv-formatted file. This data is</span>
<span class="sd">    formatted using the following XML elements:</span>

<span class="sd">      * INFO : Contains all the other elements described below, and has</span>
<span class="sd">        the attribute &quot;file&quot;, which is the name of the csv file pair of</span>
<span class="sd">        this xml file.</span>
<span class="sd">      * MODELNAME : Contains the name of the model.</span>
<span class="sd">      * HAVEPSF : A boolean value indicating whether there is a PSF</span>
<span class="sd">        associated with the model.</span>
<span class="sd">      * RMS_DATA : The uncertainty of the data.</span>
<span class="sd">      * NUMBER_FUNCTIONS : An integer indicating how many functions</span>
<span class="sd">        have been fitted to the total data.</span>

<span class="sd">    In addition to the above elements, each fitted function has its own</span>
<span class="sd">    element, designated FUNCTION, having the attribute &quot;name&quot; which is</span>
<span class="sd">    the name of the function. FUNCTION contains the following elements:</span>

<span class="sd">      * TYPE : If the function is an empirical one, this contains the</span>
<span class="sd">        string &quot;empirical&quot;. Otherwise it contains the name of the</span>
<span class="sd">        called analytical function.</span>
<span class="sd">      * DETECTION : When generating the contents of this element,</span>
<span class="sd">        The method is_nondet with the detection threshold designated</span>
<span class="sd">        by the parameter detection_threshold. The result given by</span>
<span class="sd">        the method is indicated here with a &quot;True&quot; or &quot;False&quot;</span>
<span class="sd">        depending on whether the result is considered a detection.</span>
<span class="sd">      * CSV_COLUMN : Indicates which column in the CSV contains the</span>
<span class="sd">        fitted data for this function.</span>
<span class="sd">      * NUMBER_PARAMS : Inidicates how many parameters are used by</span>
<span class="sd">        this function i.e. the number of PARAMETER elements.</span>

<span class="sd">    Finally, contained within each FUNCTION element is a number of</span>
<span class="sd">    PARAMETER elements, which list the best-fit data for each fitted</span>
<span class="sd">    parameter pertaining to that function. Each PARAMETER element</span>
<span class="sd">    contains the attribute &quot;name&quot;, which tells the name of the</span>
<span class="sd">    parameter. In addition the following elements are contained by</span>
<span class="sd">    each PARAMETER element:</span>

<span class="sd">      * VALUE : The best-fit value for this parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : `string`</span>
<span class="sd">      The extensionless version of the desired filename which the</span>
<span class="sd">      data should be exported to. As a result the files</span>
<span class="sd">      &quot;filename.csv&quot; and &quot;filename.xml&quot; are created.</span>
<span class="sd">    detection_threshold : `float`, optional</span>
<span class="sd">      The threshold of detection to be used in determining whether</span>
<span class="sd">      the value contained by the DETECTION element is true or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename_csv</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s">&#39;.csv&#39;</span>
    <span class="n">filename_xml</span> <span class="o">=</span> <span class="n">filename</span><span class="o">+</span><span class="s">&#39;.xml&#39;</span>
    <span class="n">file_xml</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_xml</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;!-- Automatically generated information file for csv file &#39;</span><span class="o">+</span><span class="n">filename_csv</span><span class="o">+</span><span class="s">&#39;--&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;INFO file=&quot;&#39;</span><span class="o">+</span><span class="n">filename_csv</span><span class="o">+</span><span class="s">&#39;&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;MODELNAME&gt;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">modelname</span><span class="o">+</span><span class="s">&#39;&lt;/MODELNAME&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;HAVEPSF&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/HAVEPSF&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;RMS_DATA&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_dy</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/RMS_DATA&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;NUMBER_FUNCTIONS&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">))</span><span class="o">+</span><span class="s">&#39;&lt;/NUMBER_FUNCTIONS&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">outdata_csv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">target_y</span><span class="p">])</span>
    <span class="n">outdata_functions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">)])</span>
    <span class="n">totRes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;FUNCTION name=&quot;&#39;</span><span class="o">+</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;TYPE&gt;&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;analytical&#39;</span><span class="p">:</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">])</span>
      <span class="k">elif</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;empirical&#39;</span><span class="p">:</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;empirical&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;unknown&#39;</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/TYPE&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;DETECTION&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_nondet</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="n">detection_threshold</span><span class="p">)[</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]])</span><span class="o">+</span><span class="s">&#39;&lt;/DETECTION&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;CSV_COLUMN&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">indFunc</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/CSV_COLUMN&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">cParlist</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;NUMBER_PARAMS&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cParlist</span><span class="p">))</span><span class="o">+</span><span class="s">&#39;&lt;/NUMBER_PARAMS&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">oPar</span><span class="o">=</span><span class="n">Parameters</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">cPar</span> <span class="ow">in</span> <span class="n">cParlist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;PARAMETER name=&quot;&#39;</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s">&#39;&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">cFitPar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">oPar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">value</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span>
                 <span class="nb">min</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">min</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                 <span class="n">expr</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;VALUE&gt;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&lt;/VALUE&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/PARAMETER&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
      <span class="n">funcRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_function</span><span class="p">(</span><span class="n">oPar</span><span class="p">,</span><span class="n">cFunc</span><span class="p">)</span>
      <span class="n">outdata_functions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">outdata_functions</span><span class="p">,</span><span class="n">funcRes</span><span class="p">])</span>
      <span class="n">totRes</span> <span class="o">+=</span> <span class="n">funcRes</span>
      <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/FUNCTION&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;/INFO&gt;&#39;</span><span class="p">)</span>
    <span class="n">file_xml</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">outdata_csv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">outdata_csv</span><span class="p">,</span><span class="n">totRes</span><span class="p">,</span><span class="n">outdata_functions</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename_csv</span><span class="p">,</span><span class="n">outdata_csv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="s">&#39;For info, see &#39;</span><span class="o">+</span><span class="n">filename_xml</span><span class="p">)</span></div>
<div class="viewcode-block" id="Fitter.is_nondet"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.is_nondet">[docs]</a>  <span class="k">def</span> <span class="nf">is_nondet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    is_nondet(sigma=5.0)</span>

<span class="sd">    Determines whether the fitted functions in the function list can</span>
<span class="sd">    be considered detections or non-detections using the given detection</span>
<span class="sd">    thereshold. This is done by comparing the peak of the fitted function</span>
<span class="sd">    within the fitting range to a multiple (set by the parameter sigma)</span>
<span class="sd">    of the RMS noise in the target data.</span>
<span class="sd">    It should be emphasized that unless the dy attribute has been set</span>
<span class="sd">    during the fitter class initialisation, the results returned by this</span>
<span class="sd">    method are meaningless.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma : `float`, optional</span>
<span class="sd">      The multiplier that should be applied to the noise when comparing</span>
<span class="sd">      it against the fitted function peaks.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A dictionary containing boolean values for each function (with</span>
<span class="sd">    their names as the keys) and the total fit (key &#39;total&#39;), with</span>
<span class="sd">    True indicating that the function is considered a non-detection</span>
<span class="sd">    using the criteria outlined above.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">minY</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">target_dy</span>
    <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_dy</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">totRes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">cParlist</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
      <span class="n">oPar</span><span class="o">=</span><span class="n">Parameters</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">cPar</span> <span class="ow">in</span> <span class="n">cParlist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">cFitPar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="n">oPar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">value</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span>
                 <span class="nb">min</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">min</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                 <span class="n">expr</span><span class="o">=</span><span class="n">cFitPar</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
      <span class="n">funcRes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_function</span><span class="p">(</span><span class="n">oPar</span><span class="p">,</span><span class="n">cFunc</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">funcRes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">False</span>
      <span class="n">totRes</span> <span class="o">+=</span> <span class="n">funcRes</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">totRes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="p">:</span>
      <span class="n">out</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out</span><span class="p">[</span><span class="s">&#39;total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">out</span></div>
<div class="viewcode-block" id="Fitter.fit_results"><a class="viewcode-back" href="../../../api/omnifit.fitter.Fitter.html#omnifit.fitter.Fitter.fit_results">[docs]</a>  <span class="k">def</span> <span class="nf">fit_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fit_results()</span>

<span class="sd">    Return the fitting results as a dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A dictionary containing all the individual functions which were</span>
<span class="sd">    fitted. The key-value combinations of this dictionary consist of</span>
<span class="sd">    the function name, and its lmfit Parameters instance, which</span>
<span class="sd">    contains the best-fit results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oResults</span><span class="o">=</span><span class="p">{}</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">oKeyname_base</span><span class="o">=</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
      <span class="n">oKeyind</span><span class="o">=</span><span class="mi">0</span>
      <span class="n">oKeyname</span><span class="o">=</span><span class="n">oKeyname_base</span>
      <span class="k">while</span> <span class="n">oResults</span><span class="o">.</span><span class="n">__contains__</span><span class="p">(</span><span class="n">oKeyname</span><span class="p">):</span> <span class="c">#In case of duplicate function names</span>
        <span class="n">oKeyind</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">oKeyname</span><span class="o">=</span><span class="n">oKeyname_base</span><span class="o">+</span><span class="s">&#39;(duplicate &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">oKeyind</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;)&#39;</span>
      <span class="n">oResults</span><span class="p">[</span><span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__fit_result</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">oResults</span></div>
  <span class="k">def</span> <span class="nf">__fit_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __fit_result(index)</span>

<span class="sd">    Return fitting results for a specific function in the internal</span>
<span class="sd">    function list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index : `int`</span>
<span class="sd">      Desired index of the function to fetch from the function lsit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    An `Parameters` instance containing the fitting</span>
<span class="sd">    results for the desired function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oParlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cParname</span> <span class="ow">in</span> <span class="n">oParlist</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">coPar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fitpars</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="n">cParname</span><span class="p">]</span>
      <span class="n">coPar</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">cParname</span>
      <span class="n">oParlist</span><span class="p">[</span><span class="n">cParname</span><span class="p">]</span><span class="o">=</span><span class="n">coPar</span>
    <span class="k">return</span> <span class="n">oParlist</span>
  <span class="k">def</span> <span class="nf">__parse_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __parse_function(params,function)</span>

<span class="sd">    Parse the input function, insert parameters, return result.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : `Parameters`</span>
<span class="sd">      The lmfit `Parameters` instance to use as input parameters.</span>
<span class="sd">    function : `dict`</span>
<span class="sd">      A dictionary formatted in the style that the entries inside</span>
<span class="sd">      funclist are formatted</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The result of the given function with given parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">function</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;empirical&#39;</span><span class="p">:</span>
      <span class="n">funcres</span><span class="o">=</span><span class="n">muldata</span><span class="p">(</span><span class="n">function</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">],</span><span class="n">params</span><span class="p">[</span><span class="s">&#39;mul&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">function</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;analytical&#39;</span><span class="p">:</span>
      <span class="n">funcres</span><span class="o">=</span><span class="nb">globals</span><span class="p">()[</span><span class="n">function</span><span class="p">[</span><span class="s">&#39;shape&#39;</span><span class="p">]](</span><span class="bp">self</span><span class="o">.</span><span class="n">target_x</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">psf</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s">&#39;Unknown function type!&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">funcres</span>
  <span class="k">def</span> <span class="nf">__extract_pars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    __extract_pars()</span>

<span class="sd">    Extracts the paramers from the function list and converts them to</span>
<span class="sd">    a single lmfit Parameters instance, which can then be manipulated</span>
<span class="sd">    by the residual minimization routines.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    None</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    An lmfit `Parameters` instance containing the parameters</span>
<span class="sd">    of *all* the fittable functions in a single place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">oPars</span><span class="o">=</span><span class="n">Parameters</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">indFunc</span><span class="p">,</span><span class="n">cFunc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funclist</span><span class="p">):</span>
      <span class="n">cParlist</span> <span class="o">=</span> <span class="n">cFunc</span><span class="p">[</span><span class="s">&#39;params&#39;</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">cPar</span> <span class="ow">in</span> <span class="n">cParlist</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">oPars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__func_ident</span><span class="p">(</span><span class="n">indFunc</span><span class="p">)</span><span class="o">+</span><span class="n">cPar</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="n">value</span><span class="o">=</span><span class="n">cPar</span><span class="o">.</span><span class="n">value</span><span class="p">,</span><span class="n">vary</span><span class="o">=</span><span class="n">cPar</span><span class="o">.</span><span class="n">vary</span><span class="p">,</span>
                  <span class="nb">min</span><span class="o">=</span><span class="n">cPar</span><span class="o">.</span><span class="n">min</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="n">cPar</span><span class="o">.</span><span class="n">max</span><span class="p">,</span>
                  <span class="n">expr</span><span class="o">=</span><span class="n">cPar</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">oPars</span>
  <span class="k">def</span> <span class="nf">__func_ident</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    __func_ident(index)</span>

<span class="sd">    Generate a unique prefix string for a function, which can be</span>
<span class="sd">    used by `__extract_pars` to generate its master Parameters list.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index : `int`</span>
<span class="sd">      The index of the function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A unique identifier string pertaining to that function, which</span>
<span class="sd">    can be used to generate unique parameter names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;__Func&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;__&#39;</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2015, Aleksi Suutarinen.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3.1. &nbsp;
    Last built 25 Aug 2015. <br/>
  </p>
</footer>
  </body>
</html>